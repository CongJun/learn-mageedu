# 网络虚拟化技术进阶2



## 不同虚拟机跨越多台虚拟机虚拟网络通信实验

![1547976354942](image/1547976354942.png)

vm1和vm3如何通信？

最简单粗暴的就是虚拟机接入虚拟桥，然后所有接口连接到物理交换机。这要求所有节点都在同一个物理网络中。

但是现实中常常遇到虚拟机不在一个机房内，不在一台计算节点，这个时候该怎么办？



### 基于GRE路由协议实现

* GRE(Gerneric Routing Encapsulation)通用路由封装协议
  * 属于三层，在IP层，将任何常见的网络层协议都封装转发到另一台主机。
  * 是一种隧道技术
  * 发送端封装，接收端解封装
  * 跨越的距离取决于GRE路由协议本身所能够支持的距离





## 实验过程

### GRE



将原先的虚拟机关闭

![1547977092870](image/1547977092870.png)

手动移除接口

![1547977114033](image/1547977114033.png)

![1547977153506](image/1547977153506.png)

一切恢复到最原始状态

另一台主机环境搭建

![1547977226117](image/1547977226117.png)

启动openvswitch，手动创建桥，下载磁盘映像文件

![1547977258475](image/1547977258475.png)

![1547977288049](image/1547977288049.png)

![1547977306300](image/1547977306300.png)

两边启动实例并且配置IP地址，使用dnsmasq来自动分配ip地址

![1547977382308](image/1547977382308.png)

因为是centos6，升级一下iproute

![1547977408635](image/1547977408635.png)



创建一个名称空间，相当于创建一个虚拟路由器。把一端放到网络名称空间，另一半接到桥上

![1547977547256](image/1547977547256.png)

配置名称空间接口

![1547977652421](image/1547977652421.png)

![1547977673066](image/1547977673066.png)

![1547977752909](image/1547977752909.png)

启动DNS服务

![1547977951663](image/1547977951663.png)

启动虚拟机检测能否获得ip地址

![1547978012296](image/1547978012296.png)

![1547978046008](image/1547978046008.png)

![1547978062709](image/1547978062709.png)

可以自动获得ip地址但是没有设定掩码

在另一台虚拟机启动一个虚拟化实例

![1547978197360](image/1547978197360.png)

安装tigervnc然后连接到VNC上

![1547978217534](image/1547978217534.png)

![1547978246146](image/1547978246146.png)

没有自动获取ip地址，毕竟没有配置

![1547978487647](image/1547978487647.png)

**GRE隧道作为独立接口，不能直接接到桥上，是作为独立接口使用的哦。桥可以借助物理接口进行通信，但是不能直接接到GRE接口**

![1547978623535](image/1547978623535.png)

![1547978687822](image/1547978687822.png)

物理接口分别配置ip地址。同网段互相ping可以连通。只要中间能够通信就行。经过路由器也是可以的。

![1547978745238](image/1547978745238.png)

如何让接口承载GRE接口通信？需要在桥上添加Port，该Port为GRE类型

![1547978844600](image/1547978844600.png)

![1547978829036](image/1547978829036.png)

![1547978866183](image/1547978866183.png)

每个port默认都有一个接口，然后设定接口属性。一个Port可以有多个接口

![1547978897103](image/1547978897103.png)

设定接口类型为GRE，并且要设定对端接口ip地址

![1547979000573](image/1547979000573.png)

构建对端隧道

![1547979104277](image/1547979104277.png)

![1547979121986](image/1547979121986.png)

另一端虚拟机重新获取ip地址，可以使用对端dhcp服务器么？

![1547979268276](image/1547979268276.png)

kill掉原先进程，重启，vnc连接查看

![1547979294188](image/1547979294188.png)

完美可以获得地址，牛逼不？神奇不？显然在一个局域网中了，既然可以获得地址，那么通信没有问题了。

![1547979330177](image/1547979330177.png)

抓包看下怎么工作的

![1547979376790](image/1547979376790.png)

![1547979408146](image/1547979408146.png)

隧道通信一览无余，牛逼~

![1547979488006](image/1547979488006.png)

继续，让vm1和vm2能够通信，vm3和vm4能够通信，但是之间不能通信，就是设定放在不同VLAN种

![1547979580225](image/1547979580225.png)

![1547979592338](image/1547979592338.png)

可以自动获取ip地址

两台模拟物理机器都启动两台虚拟机

![1547979623533](image/1547979623533.png)

![1547979640382](image/1547979640382.png)

此时彼此都能相互通信，处于同一个VLAN中

开始划分VLAN，让彼此不能随意通信，设定port的tag就可以了

![1547979746690](image/1547979746690.png)

![1547979775208](image/1547979775208.png)

![1547979794498](image/1547979794498.png)

![1547979810009](image/1547979810009.png)

![1547979822422](image/1547979822422.png)

另一台虚拟机也设定不同VLAN

![1547979868060](image/1547979868060.png)

不同虚拟机不同VLAN也ping不通了

![1547980089697](image/1547980089697.png)

只要处于同一个VLAN中就可以通信，就算不在同一个物理机中

接下来清除所有配置，回复原先状态

![1547987147570](image/1547987147570.png)

![1547987191057](image/1547987191057.png)

![1547987206742](image/1547987206742.png)

关闭GRE功能



![1547987305912](image/1547987305912.png)

执行destroy，删除不掉，因为里面有接口

![1547987345838](image/1547987345838.png)

尝试首先删除接口然后删除port。但是还是删除不掉，怎么办？

![1547987393932](image/1547987393932.png)

尝试删除掉选项呢？还是删除不掉

![1547987445183](image/1547987445183.png)

尝试直接在桥上删除，成功

![1547987461084](image/1547987461084.png)

![1547987503309](image/1547987503309.png)

删除GRE之后彼此之间隔离，不能通信了













### VxLAN

配置机制几乎与GRE一模一样，除了类型设定为VxLan



![1547987530836](image/1547987530836.png)

创建新接口

![1547987617129](image/1547987617129.png)

![1547987631634](image/1547987631634.png)

port和interface显示的结果不一样。

另一台主机上也做这样的配置

![1547987681995](image/1547987681995.png)

测试连通性

![1547987693234](image/1547987693234.png)

都能ping通，说明VxLAN配置成了

![1547987720037](image/1547987720037.png)

这里没有显示出10段的ping包信息，因为是基于VxLAN而不是GRE形式，所以，不一样，只是这里没有解码出来而已

这里VxLAN又实现了。这是很独特的协议，也较为新型的协议。



![1547987845115](image/1547987845115.png)



### 如何让VM访问Internet

**这里是最难的地方**。牛逼复杂的功能和操作，如果领会了算是大佬了。





![1547987998025](image/1547987998025.png)

SNAT+DNAT

![1547988056849](image/1547988056849.png)

这列操作比较复杂



首先清除原先的VxLAN操作



![1547988234062](image/1547988234062.png)

新增一台虚拟机，配置网络

![1547988478919](image/1547988478919.png)

这里涉及到一个技巧，需要把虚拟机内部网卡MAC地址和虚拟网卡匹配，不然有些桥接仅主机可能不是你所想的那样，所以一开始就得屡清楚才行。不然后面很容易乱。

![1547988627386](image/1547988627386.png)

修改**/etc/udev/rules.d/70-persistent-net.rules**

![1547988708916](image/1547988708916.png)

![1547988811207](image/1547988811207.png)

修改过后重新加载网络驱动，就生效了。这就相当于修改了网卡名

![1547988931751](image/1547988931751.png)

![1547989033775](image/1547989033775.png)

![1547989047350](image/1547989047350.png)

![1547989062493](image/1547989062493.png)

测试连通性。

![1547989096504](image/1547989096504.png)

添加一个ovs桥和一个普通桥就行了。把eth2放到这个桥上

![1547989145638](image/1547989145638.png)

![1547989222323](image/1547989222323.png)

br-ex设定作用于与Internet通信

![1547989252174](image/1547989252174.png)

![1547989280454](image/1547989280454.png)

![1547989297407](image/1547989297407.png)

还需要创建内部桥。还需要创建netns

新建的虚拟机安装openvswitch

![1547989365749](image/1547989365749.png)

安装过后启动服务

![1547989387565](image/1547989387565.png)

![1547989401448](image/1547989401448.png)

设定GRE接口

![1547989518816](image/1547989518816.png)

对应端也设定接口

![1547989557352](image/1547989557352.png)

此时隧道俨然建立起来

![1547989587232](image/1547989587232.png)

创建网络名称空间连接起来两个虚拟机上。升级iproute包，然后创建名称空间，centos7上就不用升级了

![1547989744417](image/1547989744417.png)

创建一对网卡，一对用来连接br-ex和br-in的接口，分别放入对应桥

![1547989812094](image/1547989812094.png)

![1547990076228](image/1547990076228.png)

![1547990160847](image/1547990160847.png)



激活对应的接口，放到对应的桥就是了

![1547989861462](image/1547989861462.png)

![1547989945903](image/1547989945903.png)

![1547990207859](image/1547990207859.png)

netns开启路由转发

![1547990275979](image/1547990275979.png)

虚拟机添加默认网关

![1547990321773](image/1547990321773.png)

添加SNAT规则

![1547990384011](image/1547990384011.png)

![1547990394408](image/1547990394408.png)

配置DNAT规则，让内部可以访问互联网

![1547990427341](image/1547990427341.png)

![1547990475384](image/1547990475384.png)

![1547990545688](image/1547990545688.png)

![1547990593101](image/1547990593101.png)

![1547990641702](image/1547990641702.png)

![1547990675213](image/1547990675213.png)

![1547990741242](image/1547990741242.png)

为什么ping包进得去出不来呢？

![1547990836069](image/1547990836069.png)

可能是物理节点上上出的问题。

![1547990858284](image/1547990858284.png)

构建小规模的OpenStack，复杂度没这么高

知道netns，知道ovs，知道GRE，知道VxLAN，之后很多事情就很简单了

复杂是步骤繁琐，不是本身原理难度有多大。



![1547990966312](image/1547990966312.png)



















































































 

















































































































































































